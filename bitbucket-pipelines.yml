options:
  docker: true

pipelines:
  branches:
    P2E2-43-pipeline-automatique-test-back-e:
      - step:
          name: Install Vendor
          script:
            - echo "Installing dependencies"
            - cp .env.example .env

            - curl -sSL https://get.docker.com/ | sh
            - curl -L "https://github.com/docker/compose/releases/download/$(curl -s https://api.github.com/repos/docker/compose/releases/latest | jq -r .tag_name)/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
            - chmod +x /usr/local/bin/docker-compose

            - docker run --rm -u "$(id -u):$(id -g)" -v "$(pwd):/var/www/html" -w /var/www/html laravelsail/php83-composer:latest composer install --ignore-platform-reqs
            - ./vendor/bin/sail up -d
            - ./vendor/bin/sail artisan run test
            - ./vendor/bin/sail down
          caches:
            - docker
            - composer
